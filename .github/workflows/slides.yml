name: Produce a stable download link for the slides
on: [push]

jobs:
  produce-slides:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: clone download
        run: |
          git clone -b download https://x-access-token:${{secrets.github_token}}@github.com/${{github.repository}}.git download
      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v2
        with:
          root_file: C++Course.tex
          latexmk_use_xelatex: true
          args: -f -pdf -interaction=nonstopmode -shell-escape
          working_directory: talk
          extra_system_packages: "py-pygments"
      - name: Commit to repo
        run: |
          set -x
          mkdir download/talk
          cp talk/C++Course.pdf download/talk
          cd download
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add -f talk/C++Course.pdf
          if (git diff --quiet) || (git diff --staged --quiet)
          then
            git commit -m "Update C++Course.pdf"
            git push origin download
          else
            echo "No changes to commit"
          fi
          git push 
